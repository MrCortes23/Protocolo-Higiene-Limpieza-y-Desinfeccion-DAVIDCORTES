<script>

function generarReporteMaquina(maquinaId, maquinaNombre) {
  if (currentUser.rol !== 'jefe') {
    showAlert('error', 'Permiso denegado', 'Solo los jefes pueden generar reportes');
    return;
  }
  
  document.getElementById('modal-message').innerHTML = `
    <strong>¿Generar reporte PDF de esta máquina?</strong>
    <br><br>
    <div style="background: #fee2e2; padding: 12px; border-radius: 6px; margin: 10px 0;">
      <strong>${maquinaNombre}</strong> (ID: ${maquinaId})
    </div>
    <p>El reporte será enviado al jefe del turno siguiente</p>
  `;
  
  window.pendingReporteMaquina = {
    maquinaId: maquinaId,
    maquinaNombre: maquinaNombre
  };
  
  document.getElementById('confirm-modal').classList.remove('hidden');
}

function ejecutarGenerarReporteMaquina() {
  if (!window.pendingReporteMaquina) {
    cerrarModal();
    return;
  }
  
  const { maquinaId, maquinaNombre } = window.pendingReporteMaquina;
  
  cerrarModal();
  showLoading();
  
  const turnoActual = obtenerTurnoActual();
  const turnoDestino = obtenerTurnoContrario(turnoActual);
  const procesoUsuario = currentUser.proceso || 'GENERAL';
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result && result.success) {
        showAlert("success", "✅ Reporte enviado", 
          `Reporte de "${maquinaNombre}" enviado al turno ${turnoDestino}`);
      } else {
        showAlert('error', 'Error', result ? result.message : 'Error al generar reporte');
      }
      window.pendingReporteMaquina = null;
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showAlert('error', 'Error de conexión', error.message);
      window.pendingReporteMaquina = null;
    })
    .generarReporteMaquinaPDF(
      maquinaId,
      maquinaNombre,
      currentUser.nombre,
      currentUser.cedula,
      turnoActual,
      turnoDestino,
      procesoUsuario
    );
}
</script>