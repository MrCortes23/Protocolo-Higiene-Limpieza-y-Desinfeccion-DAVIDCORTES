<script>

function guardarPlaneacion() {
  const elementos = Object.values(selectedElementosConfig);
  
  if (elementos.length === 0) {
    showAlert("info", "¬°Upss!", "Por favor seleccione al menos un elemento para planear"); 
    return;
  }
  
  const sinTipos = elementos.filter(e => !e.seco && !e.humedo && !e.desinfeccion);
  if (sinTipos.length > 0) {
    showAlert("info", "¬°Upss!", "Cada elemento debe tener al menos un tipo de limpieza seleccionado");
    return;
  }
  
  const frecuencia = document.getElementById('select-frecuencia').value;
  
  console.log('üíæ Guardando planeaci√≥n con estructura jer√°rquica:', elementos);
  
  // Agrupar por m√°quina y componente
  const maquinasAgrupadas = {};
  
  elementos.forEach(elem => {
    const maquinaKey = elem.maquinaId;
    
    if (!maquinasAgrupadas[maquinaKey]) {
      maquinasAgrupadas[maquinaKey] = {
        maquinaId: elem.maquinaId,
        maquinaNombre: elem.maquinaNombre,
        componentes: {}
      };
    }
    
    const componenteKey = elem.componenteNombre || 'Componente PRINCIPAL';
    
    if (!maquinasAgrupadas[maquinaKey].componentes[componenteKey]) {
      maquinasAgrupadas[maquinaKey].componentes[componenteKey] = {
        nombre: componenteKey,
        elementos: []
      };
    }
    
    maquinasAgrupadas[maquinaKey].componentes[componenteKey].elementos.push({
      elementoId: elem.elementoId,
      elementoNombre: elem.elementoNombre,
      seco: elem.seco,
      humedo: elem.humedo,
      desinfeccion: elem.desinfeccion
    });
  });
  
  showLoading();
  
  const maquinas = Object.values(maquinasAgrupadas);
  let saved = 0;
  let errors = [];
  
  maquinas.forEach(maq => {
    // Preparar datos para guardar
    const elementosConfig = [];
    const componentes = Object.values(maq.componentes);
    
    componentes.forEach(comp => {
      elementosConfig.push({
        componenteNombre: comp.nombre,
        elementos: comp.elementos
      });
    });
    
    const datos = {
      maquinaId: maq.maquinaId,
      maquinaNombre: maq.maquinaNombre,
      frecuencia: frecuencia,
      limpiezaSeco: componentes.some(comp => comp.elementos.some(e => e.seco)),
      limpiezaHumedo: componentes.some(comp => comp.elementos.some(e => e.humedo)),
      desinfeccion: componentes.some(comp => comp.elementos.some(e => e.desinfeccion)),
      elementosConfig: elementosConfig, // Ahora incluye estructura jer√°rquica
      componentes: componentes, // Informaci√≥n de componentes
      usuarioCreador: currentUser ? currentUser.nombre : 'Sistema'
    };
    
    console.log('üì§ Enviando datos jer√°rquicos:', datos);
    
    google.script.run
      .withSuccessHandler(function(result) {
        saved++;
        console.log('üì• Respuesta guardar planeaci√≥n:', result);
        
        if (result && !result.success) {
          errors.push(result.message || 'Error desconocido');
        }
        
        if (saved === maquinas.length) {
          hideLoading();
          if (errors.length === 0) {
            showAlert("success", "¬°√âxito!", "Planeaci√≥n guardada correctamente");
            selectedElementosConfig = {};
            renderMaquinasTree();
            updateElementosConfigUI();
            loadPlaneaciones();
            actualizarEstadosSidebar(); // Actualizar estados despu√©s de crear planeaci√≥n
          } else {
            showAlert('error', 'Error', 'Algunos errores ocurrieron ' + errors.join(', '));
          }
        }
      })
      .withFailureHandler(function(error) {
        saved++;
        errors.push(error.message || 'Error desconocido');
        console.error('‚ùå Error guardando planeaci√≥n:', error);
        if (saved === maquinas.length) {
          hideLoading();
          showAlert('error', 'Error', 'Error al guardar ' + errors.join(', '));
        }
      })
      .guardarPlaneacion(datos);
  });
}

function loadPlaneaciones() {
  console.log('üîÑ Cargando planeaciones...');
  showLoading();
  
  // Si es GEN, obtener todas, si no, por proceso
  if (currentUser.proceso === 'GENERAL') {
    google.script.run
      .withSuccessHandler(onPlaneacionesLoaded)
      .withFailureHandler(function(error) {
        hideLoading();
        console.error('‚ùå Error cargando planeaciones:', error);
        renderPlaneaciones([]);
      })
      .obtenerTodasLasPlaneaciones(); // ¬°NUEVA FUNCI√ìN!
  } else {
    google.script.run
      .withSuccessHandler(onPlaneacionesLoaded)
      .withFailureHandler(function(error) {
        hideLoading();
        console.error('‚ùå Error cargando planeaciones:', error);
        renderPlaneaciones([]);
      })
      .obtenerPlaneacionesPorProceso(currentUser.proceso);
  }
}

function onPlaneacionesLoaded(result) {
  hideLoading();
  console.log('üì• Respuesta de planeaciones:', result);
  
  if (!result) {
    console.error('‚ùå Error: Respuesta nula de planeaciones');
    showError('planeacion-error', 'Error: No se recibi√≥ respuesta del servidor');
    renderPlaneaciones([]);
    return;
  }
  
  if (result.success) {
    hideError('planeacion-error');
    console.log('‚úÖ Planeaciones cargadas:', result.planeaciones ? result.planeaciones.length : 0);
    renderPlaneaciones(result.planeaciones || []);
  } else {
    console.error('‚ùå Error en planeaciones:', result.message);
    showError('planeacion-error', result.message || 'Error desconocido al cargar planeaciones');
    renderPlaneaciones([]);
  }
}

</script>