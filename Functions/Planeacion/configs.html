<script>

function updateComponenteCheckState(maquinaId, componenteId) {
  const maquina = maquinasData.find(m => m.id.toString() === maquinaId.toString());
  if (!maquina || !maquina.componentes) return;
  
  const componente = maquina.componentes.find(c => c.id.toString() === componenteId.toString());
  if (!componente || !componente.elementos) return;
  
  const compCheck = document.getElementById('check-comp-' + maquinaId + '-' + componenteId);
  if (!compCheck) return;
  
  const allChecked = componente.elementos.every(elem => {
    const check = document.getElementById('check-elem-' + elem.id);
    return check && check.checked;
  });
  
  const someChecked = componente.elementos.some(elem => {
    const check = document.getElementById('check-elem-' + elem.id);
    return check && check.checked;
  });
  
  compCheck.checked = allChecked;
  compCheck.indeterminate = someChecked && !allChecked;
}

function addElementoToConfig(maquinaId, elementoId, maquinaNombre, elementoNombre, componenteNombre) {
  selectedElementosConfig[elementoId] = {
    maquinaId: maquinaId,
    elementoId: elementoId,
    maquinaNombre: maquinaNombre,
    elementoNombre: elementoNombre,
    componenteNombre: componenteNombre || 'Componente PRINCIPAL',
    seco: true,
    humedo: true,
    desinfeccion: true
  };
  
  const treeElem = document.getElementById('tree-elem-' + elementoId);
  if (treeElem) treeElem.classList.add('selected');
}

function removeElementoFromConfig(elementoId) {
  delete selectedElementosConfig[elementoId];
  
  const treeElem = document.getElementById('tree-elem-' + elementoId);
  if (treeElem) treeElem.classList.remove('selected');
}

function updateMaquinaCheckState(maquinaId) {
  const maquina = maquinasData.find(m => m.id.toString() === maquinaId.toString());
  if (!maquina || !maquina.componentes) return;
  
  const maquinaCheck = document.getElementById('check-maq-' + maquinaId);
  if (!maquinaCheck) return;
  
  const allChecked = maquina.componentes.every(componente => {
    const compCheck = document.getElementById('check-comp-' + maquinaId + '-' + componente.id);
    return compCheck && compCheck.checked;
  });
  
  const someChecked = maquina.componentes.some(componente => {
    const compCheck = document.getElementById('check-comp-' + maquinaId + '-' + componente.id);
    return compCheck && compCheck.checked;
  });
  
  maquinaCheck.checked = allChecked;
  maquinaCheck.indeterminate = someChecked && !allChecked;
}


function updateElementosConfigUI() {
  const container = document.getElementById('elementos-config-list');
  const elementos = Object.values(selectedElementosConfig);
  
  if (elementos.length === 0) {
    container.innerHTML = '<p class="config-placeholder">Seleccione elementos del árbol para configurar sus tipos de limpieza</p>';
    return;
  }
  
  container.innerHTML = elementos.map(elem => `
    <div class="elemento-config-item">
      <div class="elemento-config-name">${elem.maquinaNombre} - ${elem.componenteNombre} - ${elem.elementoNombre}</div>
      <div class="checkbox-group">
        <label class="checkbox-item">
          <input type="checkbox" id="cfg-seco-${elem.elementoId}" ${elem.seco ? 'checked' : ''} onchange="updateElementoConfig('${elem.elementoId}', 'seco', this.checked)">
          Limpieza Seco
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="cfg-humedo-${elem.elementoId}" ${elem.humedo ? 'checked' : ''} onchange="updateElementoConfig('${elem.elementoId}', 'humedo', this.checked)">
          Limpieza Húmedo
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="cfg-desinfeccion-${elem.elementoId}" ${elem.desinfeccion ? 'checked' : ''} onchange="updateElementoConfig('${elem.elementoId}', 'desinfeccion', this.checked)">
          Desinfección
        </label>
      </div>
    </div>
  `).join('');
}

function updateElementoConfig(elementoId, tipo, value) {
  if (selectedElementosConfig[elementoId]) {
    selectedElementosConfig[elementoId][tipo] = value;
  }
}

</script>