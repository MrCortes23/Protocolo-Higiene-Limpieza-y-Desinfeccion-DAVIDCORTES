<script>

// Función para obtener todos los registros de limpieza
function obtenerTodosRegistrosLimpieza() {
  return new Promise((resolve) => {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          resolve(result.registros || []);
        } else {
          resolve([]);
        }
      })
      .withFailureHandler(function() {
        resolve([]);
      })
      .obtenerTodosRegistrosLimpieza(); // ¡CAMBIA AQUÍ!
  });
}

// Función para calcular estado de un elemento
function calcularEstadoElemento(registros) {
  if (!registros || registros.length === 0) {
    return 'PENDIENTE';
  }
  
  const todosCompletados = registros.every(r => r.estado === 'COMPLETADO');
  const algunoValidado = registros.some(r => r.validadoPor && r.validadoPor !== '');
  const algunoCompletado = registros.some(r => r.estado === 'COMPLETADO');
  
  if (algunoValidado) {
    return 'VALIDADO';
  } else if (todosCompletados) {
    return 'COMPLETADO';
  } else if (algunoCompletado) {
    return 'EN-PROCESO';
  } else {
    return 'PENDIENTE';
  }
}

// Función para obtener icono según estado
function obtenerIconoEstado(estado) {
  switch(estado) {
    case 'VALIDADO': return '<i class="fa-jelly fa-regular fa-thumbs-up"></i>';
    case 'COMPLETADO': return '<i class="fas fa-check-circle"></i>';
    case 'EN-PROCESO': return '<i class="fas fa-spinner"></i>';
    case 'PENDIENTE': return '<i class="fas fa-clock"></i>';
    default: return '<i class="fas fa-question-circle"></i>';
  }
}

function calcularTotalComponentes(maquinas) {
  return maquinas.reduce((sum, m) => sum + m.componentes.length, 0);
}

function calcularTotalElementos(maquinas) {
  return maquinas.reduce((sum, m) => sum + m.estadisticas.total, 0);
}

// ==================== EN PROCESO ====================
function loadProceso() {
  showLoading();
  
  // Para GEN, obtener todos los registros
  if (currentUser.proceso === 'GENERAL') {
    google.script.run
      .withSuccessHandler(onProcesoLoaded)
      .withFailureHandler(function(error) {
        hideLoading();
        console.error('Error cargando proceso:', error);
        renderProceso([]);
      })
      .obtenerTodosRegistrosLimpieza(); // ¡NUEVA FUNCIÓN!
  } else {
    google.script.run
      .withSuccessHandler(onProcesoLoaded)
      .withFailureHandler(function(error) {
        hideLoading();
        console.error('Error cargando proceso:', error);
        renderProceso([]);
      })
      .obtenerRegistrosLimpiezaPorProceso(currentUser.proceso, null, null);
  }
}

function onProcesoLoaded(result) {
  hideLoading();
  
  if (result && result.success) {
    renderProceso(result.registros || []);
  } else {
    renderProceso([]);
  }
}

function renderProceso(registros) {
  const container = document.getElementById('proceso-content');
  container.innerHTML = '';
  
  if (!registros || registros.length === 0) {
    container.innerHTML = '<p class="config-placeholder">No hay limpiezas en proceso</p>';
    return;
  }
  
  const grouped = {};
  registros.forEach(reg => {
    if (!grouped[reg.maquinaId]) {
      grouped[reg.maquinaId] = {
        nombre: reg.maquinaNombre,
        registros: []
      };
    }
    grouped[reg.maquinaId].registros.push(reg);
  });
  
  Object.keys(grouped).forEach(maquinaId => {
    const maquina = grouped[maquinaId];
    const card = document.createElement('div');
    card.className = 'proceso-card';
    
    const elementosHtml = maquina.registros.slice(0, 5).map(reg => `
      <div class="proceso-elemento">
        <span>${reg.elementoNombre} - ${reg.tipoLimpieza}</span>
        <span class="estado-badge ${reg.estado === 'COMPLETADO' ? 'estado-completado' : 'estado-pendiente'}">
          ${reg.estado}
        </span>
      </div>
    `).join('');
    
    card.innerHTML = `
      <div class="proceso-card-title">${maquina.nombre}</div>
      <div class="proceso-card-elementos">${elementosHtml}</div>
    `;
    
    container.appendChild(card);
  });
}

</script>