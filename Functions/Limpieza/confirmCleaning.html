<script>

function confirmarLimpieza() {
  if (!pendingCheckboxData) {
    cerrarModal();
    return;
  }
  
  const tipo = pendingCheckboxData.tipo;
  const registroId = pendingCheckboxData.registroId;
  
  // Obtener valores del formulario
  const responsableInput = document.getElementById('responsable-' + tipo);
  const fechaInput = document.getElementById('fecha-' + tipo);
  const observacionesInput = document.getElementById('observaciones-' + tipo);
  
  // El responsable ahora es automÃ¡tico, pero verificar que estÃ© presente
  const responsable = currentUser ? currentUser.nombre : 
                    (responsableInput ? responsableInput.value : '');
  const fecha = fechaInput ? fechaInput.value : '';
  const observaciones = observacionesInput ? observacionesInput.value : '';
  
  // Validaciones
  if (!responsable || responsable.trim() === '') {
    showAlert("error", "Â¡Error!", "No se pudo obtener el nombre del usuario. Cierre sesiÃ³n y vuelva a ingresar.");
    const checkbox = document.getElementById('check-' + tipo);
    if (checkbox) checkbox.checked = false;
    cerrarModal();
    return;
  }
  
  if (!fecha) {
    showAlert("info", "Â¡Upss!", "Por favor seleccione la fecha en que realizÃ³ la limpieza");
    const checkbox = document.getElementById('check-' + tipo);
    if (checkbox) checkbox.checked = false;
    cerrarModal();
    return;
  }
  
  // Validar que la fecha no sea futura
  const fechaSeleccionada = new Date(fecha);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada > hoy) {
    showAlert("warning", "Fecha invÃ¡lida", "No puede seleccionar una fecha futura");
    const checkbox = document.getElementById('check-' + tipo);
    if (checkbox) checkbox.checked = false;
    cerrarModal();
    return;
  }
  
  cerrarModal();
  showLoading();
  
  const datos = {
    estado: 'COMPLETADO',
    responsable: responsable.trim(),
    fechaRealizacion: fecha,
    observaciones: observaciones.trim()
  };
  
  console.log('ðŸ“¤ Enviando datos de limpieza:', datos);
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result && result.success) {
        showAlert("success", "Â¡Ã‰xito!", "Limpieza registrada correctamente");
        loadElementoTiposLimpieza();
        actualizarEstadosSidebar(); 
      } else {
        showAlert('error', 'Error', 'Error al registrar: ' + (result ? result.message : 'Error desconocido'));
        const checkbox = document.getElementById('check-' + tipo);
        if (checkbox) checkbox.checked = false;
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showAlert('error', 'Error', 'Error de conexiÃ³n: ' + error.message);
      const checkbox = document.getElementById('check-' + tipo);
      if (checkbox) checkbox.checked = false;
    })
    .actualizarRegistroLimpiezaCompleto(registroId, datos);
  
  pendingCheckboxData = null;
}

// Enter key para login
document.addEventListener('DOMContentLoaded', function() {
  const cedulaInput = document.getElementById('cedula-input');
  if (cedulaInput) {
    cedulaInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });
  }
  
  // Test: Verificar que handleLogin existe
  console.log('âœ… handleLogin definido:', typeof handleLogin);
});
</script>