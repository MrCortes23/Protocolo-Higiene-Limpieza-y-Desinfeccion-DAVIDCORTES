<script>

function finalizarLimpieza() {
  // Verificar que hay un elemento seleccionado
  if (!currentElementoId || !currentMaquinaId) {
    showAlert('error', 'Error', 'No hay elemento seleccionado');
    return;
  }
  
  // Verificar que el usuario sea operario
  if (currentUser.rol !== 'operario') {
    showAlert('error', 'Permiso denegado', 'Solo los operarios pueden finalizar limpiezas');
    return;
  }
  
  console.log('üîç Finalizando limpieza para elemento:', {
    elementoId: currentElementoId,
    elementoNombre: currentElementoNombre,
    maquinaId: currentMaquinaId,
    maquinaNombre: currentMaquinaNombre
  });
  
  // Verificar cu√°les tipos de limpieza est√°n pendientes
  const tiposPendientes = obtenerTiposLimpiezaPendientes();
  
  if (tiposPendientes.length === 0) {
    showAlert('info', '¬°Genial!', 'No hay limpiezas pendientes para finalizar');
    return;
  }
  
  // Mostrar modal de confirmaci√≥n con los tipos pendientes
  mostrarModalFinalizarLimpieza(tiposPendientes);
}

function obtenerTiposLimpiezaPendientes() {
  if (!currentElementoTiposLimpieza || currentElementoTiposLimpieza.length === 0) {
    return [];
  }
  
  const pendientes = currentElementoTiposLimpieza.filter(reg => 
    reg.estado !== 'COMPLETADO' && reg.estado !== 'VALIDADO'
  );
  
  return pendientes.map(reg => reg.tipoLimpieza);
}

function mostrarModalFinalizarLimpieza(tiposPendientes) {
  const tiposNombres = {
    'SECO': 'Limpieza Seco',
    'HUMEDO': 'Limpieza H√∫medo', 
    'DESINFECCION': 'Desinfecci√≥n'
  };
  
  let listaTipos = '';
  tiposPendientes.forEach(tipo => {
    listaTipos += `<li>‚Ä¢ ${tiposNombres[tipo] || tipo}</li>`;
  });
  
  document.getElementById('modal-message').innerHTML = `
    <strong>¬øFinalizar todas las limpiezas pendientes de este elemento?</strong>
    <br><br>
    <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
      <div style="font-weight: 600; color: #0369a1; margin-bottom: 4px;">
        <i class="fas fa-industry"></i> ELEMENTO A FINALIZAR:
      </div>
      <div style="color: #0c4a6e; font-size: 14px;">
        <strong>${currentElementoNombre}</strong><br>
        M√°quina: ${currentMaquinaNombre}
      </div>
    </div>
    
    <div style="font-size: 13px; color: #4b5563; margin: 12px 0;">
      <p style="margin: 8px 0;"><i class="fas fa-broom"></i> Limpiezas pendientes:</p>
      <ul style="margin: 8px 0; padding-left: 20px;">
        ${listaTipos}
      </ul>
      <p style="margin: 8px 0; color: #059669; font-weight: 600;">
        <i class="fas fa-check-circle"></i> Esta acci√≥n marcar√° como COMPLETADO todos los tipos de limpieza pendientes.
      </p>
    </div>
  `;
  
  // Cambiar t√≠tulo del modal
  const modalTitle = document.querySelector('.modal-title');
  if (modalTitle) {
    modalTitle.textContent = 'Finalizar Limpieza Completa';
  }
  
  // Configurar botones del modal
  const confirmBtn = document.querySelector('.btn-confirm');
  const cancelBtn = document.querySelector('.btn-cancel');
  
  if (confirmBtn) {
    confirmBtn.textContent = 'Finalizar Todas';
    confirmBtn.style.backgroundColor = '#10b981';
    confirmBtn.style.borderColor = '#10b981';
  }
  
  if (cancelBtn) {
    cancelBtn.textContent = 'Cancelar';
  }
  
  // Mostrar el modal
  document.getElementById('confirm-modal').classList.remove('hidden');
  
  // Configurar callback
  window.pendingFinalizarCompleto = {
    elementoId: currentElementoId,
    tiposPendientes: tiposPendientes
  };
}

function confirmarFinalizarCompleto() {
  if (!window.pendingFinalizarCompleto) return;
  
  const { elementoId, tiposPendientes } = window.pendingFinalizarCompleto;
  
  cerrarModal();
  showLoading();
  
  console.log('üì§ Finalizando limpiezas completas para:', {
    elementoId: elementoId,
    tipos: tiposPendientes,
    responsable: currentUser.nombre
  });
  
  // Obtener fecha actual
  const fechaActual = new Date().toISOString().split('T')[0];
  
  // Para cada tipo pendiente, obtener el registro ID y actualizarlo
  const actualizaciones = tiposPendientes.map(tipo => {
    const registro = currentElementoTiposLimpieza.find(reg => 
      reg.tipoLimpieza === tipo && 
      reg.estado !== 'COMPLETADO' && 
      reg.estado !== 'VALIDADO'
    );
    
    return registro ? {
      registroId: registro.id,
      tipoLimpieza: tipo,
      datos: {
        estado: 'COMPLETADO',
        responsable: currentUser.nombre,
        fechaRealizacion: fechaActual,
        observaciones: 'Finalizado autom√°ticamente desde "Finalizar Limpieza"',
        fechaFinalizacion: new Date().toISOString()
      }
    } : null;
  }).filter(item => item !== null);
  
  console.log('üîÑ Actualizaciones a realizar:', actualizaciones.length);
  
  if (actualizaciones.length === 0) {
    hideLoading();
    showAlert('info', 'Sin cambios', 'No hay limpiezas pendientes para actualizar');
    window.pendingFinalizarCompleto = null;
    return;
  }
  
  // Contador para seguimiento
  let actualizados = 0;
  let errores = 0;
  const total = actualizaciones.length;
  
  // Actualizar cada registro
  actualizaciones.forEach((actualizacion, index) => {
    google.script.run
      .withSuccessHandler(function(result) {
        actualizados++;
        
        if (result && !result.success) {
          errores++;
          console.error(`‚ùå Error en ${actualizacion.tipoLimpieza}:`, result.message);
        } else {
          console.log(`‚úÖ ${actualizacion.tipoLimpieza} completado`);
        }
        
        // Cuando todas las actualizaciones terminen
        if (actualizados + errores === total) {
          hideLoading();
          
          if (errores === 0) {
            showAlert("success", "‚úÖ ¬°√âxito!", 
              `Finalizadas ${actualizados} limpieza(s) para este elemento`);
            
            // Recargar los datos del elemento
            loadElementoTiposLimpieza();
            
            // Actualizar estados en sidebar
            actualizarEstadosSidebar();
            
          } else if (actualizados > 0) {
            showAlert("warning", "Parcialmente completado", 
              `${actualizados} completados, ${errores} errores`);
            
            // Recargar igualmente
            loadElementoTiposLimpieza();
            
          } else {
            showAlert('error', 'Error', `No se pudo finalizar ninguna limpieza`);
          }
          
          window.pendingFinalizarCompleto = null;
        }
      })
      .withFailureHandler(function(error) {
        actualizados++;
        errores++;
        console.error(`‚ùå Error de conexi√≥n en ${actualizacion.tipoLimpieza}:`, error);
        
        if (actualizados + errores === total) {
          hideLoading();
          showAlert('error', 'Error', `Errores al finalizar: ${errores}/${total}`);
          window.pendingFinalizarCompleto = null;
        }
      })
      .actualizarRegistroLimpiezaCompleto(
        actualizacion.registroId,
        actualizacion.datos
      );
  });
}

</script>