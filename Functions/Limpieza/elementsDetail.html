<script>

function selectElemento(maquinaId, elementoId, maquinaNombre, elementoNombre, componenteNombre) {
  currentMaquinaId = maquinaId;
  currentElementoId = elementoId;
  currentMaquinaNombre = maquinaNombre;
  currentElementoNombre = elementoNombre;
  
  console.log('üéØ Elemento seleccionado:', {
    maquinaId: maquinaId,
    elementoId: elementoId,
    maquinaNombre: maquinaNombre,
    elementoNombre: elementoNombre
  });
  
  document.getElementById('elemento-title').textContent = maquinaNombre + ' - ' + componenteNombre + ' - ' + elementoNombre;
  
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
  document.getElementById('content-elemento').classList.remove('hidden');
  
  document.querySelectorAll('.elemento-item').forEach(item => item.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');
  
  // Ejecutar debug
  debugElementoSeleccionado();
  
  loadElementoTiposLimpieza();
}

function loadElementoTiposLimpieza() {
  console.log('üîÑ Cargando tipos de limpieza para:', {
    maquinaId: currentMaquinaId,
    elementoId: currentElementoId
  });
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(onTiposLimpiezaLoaded)
    .withFailureHandler(function(error) {
      hideLoading();
      console.error('‚ùå Error cargando tipos de limpieza:', error);
      showNoRegistrosMessage();
    })
    .obtenerRegistrosLimpieza(currentMaquinaId, currentElementoId);
}

function onTiposLimpiezaLoaded(result) {
  hideLoading();
  console.log('üì• Respuesta tipos limpieza:', result);
  
  if (!result) {
    console.error('‚ùå Error: Respuesta nula de tipos limpieza');
    showNoRegistrosMessage();
    return;
  }
  
  if (result.success) {
    currentElementoTiposLimpieza = result.registros || [];
    console.log('‚úÖ Tipos de limpieza cargados:', currentElementoTiposLimpieza.length);
    
    if (currentElementoTiposLimpieza.length === 0) {
      showNoRegistrosMessage();
    } else {
      renderLimpiezaSections();
      // SOLO llamar verificarEstadoValidacion si estamos en la vista correcta
      if (document.getElementById('content-elemento') && 
          !document.getElementById('content-elemento').classList.contains('hidden')) {
        verificarEstadoValidacion();
      }
    }
  } else {
    console.error('‚ùå Error en tipos limpieza:', result.message);
    showNoRegistrosMessage();
  }
}

function showNoRegistrosMessage() {
  const container = document.getElementById('limpieza-sections');
  container.innerHTML = `
    <div class="empty-state">
      <p class="config-placeholder">No hay tipos de limpieza configurados para este elemento</p>
      <p class="empty-state-hint">Este elemento no tiene registros de limpieza pendientes. Verifique:</p>
      <ul style="text-align: left;margin: 1rem 0;font-size: 14.4px;color: var(--text-muted);">
        <li>Que el elemento est√© incluido en una planeaci√≥n activa</li>
        <li>Que la planeaci√≥n tenga tipos de limpieza configurados</li>
        <li>Que los registros se hayan creado correctamente</li>
      </ul>
      <button onclick="loadElementoTiposLimpieza()" class="btn-principal">Reintentar</button>
    </div>
  `;
  document.getElementById('btn-finalizar').classList.add('hidden');
}

</script>