<script>

    // ==================== ELIMINAR PLANEACI√ìN (CON MODAL) ====================
    function eliminarPlaneacionMaquina(maquinaId, maquinaNombre) {
        // Guardar los datos en variables globales para usarlos en la confirmaci√≥n
        window.pendingMaquinaDelete = {
            maquinaId: maquinaId,
            maquinaNombre: maquinaNombre
        };

        // Configurar el mensaje del modal
        const modalMessage = document.getElementById('modal-message');
        modalMessage.innerHTML = `
    <div style="text-align: left;">
      <strong>¬øEst√° seguro que desea eliminar todas las planeaciones de la m√°quina?</strong>
      <br><br>
      <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border-left: 4px solid #f59e0b; margin: 10px 0;">
        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">
          <i class="fas fa-exclamation-triangle"></i> M√ÅQUINA A ELIMINAR:
        </div>
        <div style="color: #78350f; font-size: 14px;">
          <strong>${maquinaNombre}</strong> (ID: ${maquinaId})
        </div>
      </div>
      
      <div style="font-size: 13px; color: #4b5563; margin: 12px 0;">
        <p style="margin: 8px 0;"><i class="fas fa-trash"></i> Esta acci√≥n eliminar√°:</p>
        <ul style="margin: 8px 0; padding-left: 20px;">
          <li>Todas las planeaciones de esta m√°quina</li>
          <li>Todos los registros de limpieza asociados</li>
          <li>Los elementos configurados en la planeaci√≥n</li>
        </ul>
        <p style="margin: 8px 0; color: #dc2626; font-weight: 600;">
          <i class="fas fa-exclamation-circle"></i> ¬°Esta acci√≥n no se puede deshacer!
        </p>
      </div>
      
      <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
        Para confirmar, escriba el nombre de la m√°quina: 
        <input type="text" id="confirm-delete-input" 
               placeholder="Escriba '${maquinaNombre}' aqu√≠" 
               style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #d1d5db; border-radius: 4px;"
               onkeyup="validarConfirmacionEliminacion()">
        <div id="confirm-delete-error" style="color: #dc2626; font-size: 11px; margin-top: 4px; display: none;">
          El nombre no coincide
        </div>
      </div>
    </div>
  `;

        // Cambiar el t√≠tulo del modal
        const modalTitle = document.querySelector('.modal-title');
        if (modalTitle) {
            modalTitle.textContent = 'Confirmar Eliminaci√≥n';
        }

        // Configurar los botones del modal
        const confirmBtn = document.querySelector('.btn-confirm');
        const cancelBtn = document.querySelector('.btn-cancel');

        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.cursor = 'not-allowed';
            confirmBtn.textContent = 'Eliminar';

            // Cambiar color para eliminar (rojo)
            confirmBtn.style.backgroundColor = '#dc2626';
            confirmBtn.style.borderColor = '#dc2626';
        }

        if (cancelBtn) {
            cancelBtn.textContent = 'Cancelar';
        }

        // Mostrar el modal
        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    // Funci√≥n para ejecutar la eliminaci√≥n despu√©s de la confirmaci√≥n
    function ejecutarEliminacionMaquina() {
        if (!window.pendingMaquinaDelete) {
            cerrarModal();
            return;
        }

        const { maquinaId, maquinaNombre } = window.pendingMaquinaDelete;

        cerrarModal();
        showLoading();

        console.log('üóëÔ∏è Eliminando planeaciones de m√°quina:', { maquinaId, maquinaNombre });

        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result && result.success) {
                    showAlert("success", "¬°Eliminado!", result.message);
                    loadPlaneaciones(); // Recargar el consolidado
                    actualizarEstadosSidebar(); // Actualizar sidebar

                    // Limpiar cache de estados
                    estadosElementosCache = {};
                } else {
                    showAlert('error', 'Error al eliminar', result ? result.message : 'Error desconocido');
                }
                window.pendingMaquinaDelete = null;
            })
            .withFailureHandler(function (error) {
                hideLoading();
                showAlert('error', 'Error de conexi√≥n', error.message);
                window.pendingMaquinaDelete = null;
            })
            .eliminarPlaneacionesMaquina(maquinaId);
    }

    // Funci√≥n para validar que el nombre coincida
    function validarConfirmacionEliminacion() {
        const input = document.getElementById('confirm-delete-input');
        const confirmBtn = document.querySelector('.btn-confirm');
        const errorMsg = document.getElementById('confirm-delete-error');

        if (!input || !confirmBtn || !window.pendingMaquinaDelete) return;

        const nombreIngresado = input.value.trim();
        const nombreCorrecto = window.pendingMaquinaDelete.maquinaNombre;

        if (nombreIngresado === nombreCorrecto) {
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
            if (errorMsg) errorMsg.style.display = 'none';
        } else {
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.cursor = 'not-allowed';
            if (errorMsg && nombreIngresado !== '') {
                errorMsg.style.display = 'block';
            } else if (errorMsg) {
                errorMsg.style.display = 'none';
            }
        }
    }

</script>