<script>

    // ==================== FUNCIONES DE TURNO ====================

    function obtenerTurnoActual() {
        const horaActual = new Date().getHours();

        // MA√ëANA: 6:00 AM - 1:59 PM (6 a 13 horas)
        // TARDE: 2:00 PM - 9:59 PM (14 a 21 horas)
        // NOCHE: 10:00 PM - 5:59 AM (22 a 5 horas)

        if (horaActual >= 6 && horaActual < 14) {
            return 'MA√ëANA';
        } else if (horaActual >= 14 && horaActual < 22) {
            return 'TARDE';
        } else {
            return 'NOCHE';
        }
    }

    function obtenerTurnoContrario(turno) {
        const turnos = {
            'MA√ëANA': 'TARDE',
            'TARDE': 'NOCHE',
            'NOCHE': 'MA√ëANA'
        };

        return turnos[turno.toUpperCase()] || 'TARDE';
    }
    // ==================== REPORTE POR M√ÅQUINA VALIDADA ====================

    function generarReporteMaquina(maquinaId, maquinaNombre) {
        if (!currentUser || currentUser.rol !== 'jefe') {
            showAlert('error', 'Permiso denegado', 'Solo los jefes pueden generar reportes');
            return;
        }

        // Verificar que la m√°quina est√© validada
        const maquinaElement = document.querySelector(`[data-maquina-id="${maquinaId}"]`);
        if (!maquinaElement) {
            showAlert('error', 'Error', 'No se encontr√≥ la m√°quina en el consolidado');
            return;
        }

        const estadoValidacion = maquinaElement.querySelector('.validacion-resumen');
        if (!estadoValidacion || estadoValidacion.style.display === 'none') {
            showAlert('error', 'No validada', 'La m√°quina debe estar validada para generar un reporte');
            return;
        }

        const turnoActual = obtenerTurnoActual();
        const turnoDestino = obtenerTurnoContrario(turnoActual);
        const emailDestino = obtenerCorreoPorTurno(turnoDestino);

        document.getElementById('modal-message').innerHTML = `
        <strong>¬øGenerar reporte PDF de esta m√°quina?</strong>
        <br><br>
        <div style="background: #fee2e2; padding: 12px; border-radius: 6px; margin: 10px 0;">
            <strong>${maquinaNombre}</strong> (ID: ${maquinaId})
        </div>
        <div style="font-size: 13px; color: #4b5563; margin: 12px 0;">
            <p><strong>Destino del reporte:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
                <li><strong>Turno:</strong> ${turnoDestino}</li>
                <li><strong>Correo:</strong> ${emailDestino}</li>
                <li><strong>Jefe origen:</strong> ${currentUser.nombre}</li>
                <li><strong>Turno origen:</strong> ${turnoActual}</li>
            </ul>
            <p style="margin: 8px 0; color: #dc2626; font-weight: 600;">
                <i class="fas fa-file-pdf"></i> Se generar√° un reporte PDF detallado y se enviar√° por correo.
            </p>
        </div>
    `;

        window.pendingReporteMaquina = {
            maquinaId: maquinaId,
            maquinaNombre: maquinaNombre
        };

        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    function ejecutarGenerarReporteMaquina() {
        if (!window.pendingReporteMaquina) {
            cerrarModal();
            return;
        }

        const { maquinaId, maquinaNombre } = window.pendingReporteMaquina;

        cerrarModal();
        showLoading();

        const turnoActual = obtenerTurnoActual();
        const turnoDestino = obtenerTurnoContrario(turnoActual);
        const procesoUsuario = currentUser.proceso || 'GENERAL';

        // Obtener el correo destino CORRECTAMENTE
        const emailDestino = obtenerCorreoPorTurno(turnoDestino);

        console.log('üì§ Generando reporte con par√°metros:', {
            maquinaId,
            maquinaNombre,
            jefeOrigenNombre: currentUser.nombre,
            jefeOrigenCedula: currentUser.cedula,
            turnoOrigen: turnoActual,
            turnoDestino,
            procesoUsuario,
            emailDestino  // ‚Üê Aseg√∫rate de que esta variable tenga valor
        });

        // Verificar que emailDestino tenga valor
        if (!emailDestino || emailDestino.trim() === '') {
            hideLoading();
            showAlert('error', 'Error', 'No se pudo determinar el correo destino para el turno ' + turnoDestino);
            window.pendingReporteMaquina = null;
            return;
        }

        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result && result.success) {
                    showAlert("success", "‚úÖ Reporte enviado",
                        `Reporte de "${maquinaNombre}" enviado a:\n${emailDestino}\nTurno: ${turnoDestino}`);

                    // Recargar el consolidado para reflejar cambios
                    loadPlaneaciones();
                } else {
                    showAlert('error', 'Error', result ? result.message : 'Error al generar reporte');
                }
                window.pendingReporteMaquina = null;
            })
            .withFailureHandler(function (error) {
                hideLoading();
                showAlert('error', 'Error de conexi√≥n', error.message);
                window.pendingReporteMaquina = null;
            })
            .generarReporteMaquinaPDF(
                maquinaId,
                maquinaNombre,
                currentUser.nombre,
                currentUser.cedula || '',
                turnoActual,
                turnoDestino,
                procesoUsuario,
                emailDestino  // ‚Üê ¬°IMPORTANTE! Pasar emailDestino como octavo par√°metro
            );
    }

</script>