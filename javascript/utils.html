<script>

    // ==================== FUNCIONES DE UTILIDAD ====================
    function showLoading() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = message;
            element.classList.remove('hidden');
        }
    }

    function hideError(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.classList.add('hidden');
        }
    }

    // Función auxiliar para obtener fecha sin problemas de zona horaria
    function obtenerFechaSinZonaHoraria(fechaString) {
        if (!fechaString) return new Date();

        // Si la fecha ya es un objeto Date, devolver copia
        if (fechaString instanceof Date) {
            return new Date(fechaString.getTime());
        }

        // Si es string, parsear correctamente
        const fecha = new Date(fechaString);

        // Crear nueva fecha ajustando la zona horaria
        const fechaAjustada = new Date(
            fecha.getUTCFullYear(),
            fecha.getUTCMonth(),
            fecha.getUTCDate(),
            12, 0, 0 // Poner a mediodía para evitar problemas de zona horaria
        );

        return fechaAjustada;
    }

    // Función para obtener la fecha de hoy sin hora (medianoche local)
    function obtenerHoySinHora() {
        const hoy = new Date();
        // Establecer a medianoche en hora local
        return new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
    }

    // Función para formatear fecha en formato local sin problemas
    function formatearFechaLocal(fecha) {
        if (!fecha) return '';

        // Asegurarse de que es un objeto Date
        const fechaObj = fecha instanceof Date ? fecha : new Date(fecha);

        // Formatear en español
        return fechaObj.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            timeZone: 'UTC' // Usar UTC para evitar desplazamientos
        });
    }

    // Función para obtener todos los registros de limpieza
    function obtenerTodosRegistrosLimpieza() {
        return new Promise((resolve) => {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result && result.success) {
                        resolve(result.registros || []);
                    } else {
                        resolve([]);
                    }
                })
                .withFailureHandler(function () {
                    resolve([]);
                })
                .obtenerTodosRegistrosLimpieza(); // ¡CAMBIA AQUÍ!
        });
    }

    // Función para calcular estado de un elemento
    function calcularEstadoElemento(registros) {
        if (!registros || registros.length === 0) {
            return 'PENDIENTE';
        }

        const todosCompletados = registros.every(r => r.estado === 'COMPLETADO');
        const algunoValidado = registros.some(r => r.validadoPor && r.validadoPor !== '');
        const algunoCompletado = registros.some(r => r.estado === 'COMPLETADO');

        if (algunoValidado) {
            return 'VALIDADO';
        } else if (todosCompletados) {
            return 'COMPLETADO';
        } else if (algunoCompletado) {
            return 'EN-PROCESO';
        } else {
            return 'PENDIENTE';
        }
    }

    // Función para obtener icono según estado
    function obtenerIconoEstado(estado) {
        switch (estado) {
            case 'VALIDADO': return '<i class="fa-jelly fa-regular fa-thumbs-up"></i>';
            case 'COMPLETADO': return '<i class="fas fa-check-circle"></i>';
            case 'EN-PROCESO': return '<i class="fas fa-spinner"></i>';
            case 'PENDIENTE': return '<i class="fas fa-clock"></i>';
            default: return '<i class="fas fa-question-circle"></i>';
        }
    }

    function formatFechaSimple(fechaString) {
        if (!fechaString) return '';

        try {
            // Usar la función segura para evitar problemas de zona horaria
            const fecha = obtenerFechaSinZonaHoraria(fechaString);

            // Formatear sin problemas
            return fecha.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                timeZone: 'UTC'
            });
        } catch (e) {
            console.warn('⚠️ Error formateando fecha:', fechaString, e);
            // Intentar formato simple
            try {
                const partes = fechaString.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
                return fechaString;
            } catch {
                return fechaString;
            }
        }
    }

    function calcularTotalComponentes(maquinas) {
        return maquinas.reduce((sum, m) => sum + m.componentes.length, 0);
    }

    function calcularTotalElementos(maquinas) {
        return maquinas.reduce((sum, m) => sum + m.estadisticas.total, 0);
    }

</script>